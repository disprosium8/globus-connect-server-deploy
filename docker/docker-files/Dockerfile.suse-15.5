# syntax=docker/dockerfile:1.3-labs

############### STAGE 1 - Prepare the image for GCS installation ###############
FROM opensuse/leap:15.5

# Prereqs
RUN <<EOF
    zypper install -y coreutils gzip python3 sudo tar util-linux
EOF

##################### STAGE 2 - Install GCS using Ansible ######################
# This is the base64 compressed tar of the ansible repo directory
COPY <<EOF /ansible.64
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
EOF

RUN <<EOF
    set -e
    /usr/bin/python3 -m venv /venv
    /venv/bin/pip install --upgrade pip
    /venv/bin/pip install ansible
    cat /ansible.64 | base64 -d | (cd /; tar zxf -)
EOF

ARG GLOBUS_ANSIBLE_OPTIONS

# Modifying this arg value on the build command line will cause RUN to reinstall
# Globus instead of using the previous, cached iteration (if it exists). Useful
# for speeding up re-runs to get newer Globus versions.
ARG CACHEBUST=1

RUN <<EOF
    (cd /ansible; /venv/bin/ansible-playbook playbook.yml ${GLOBUS_ANSIBLE_OPTIONS})
EOF

######################### STAGE 3 - Prepare GCS Image ##########################
LABEL maintainer="support@globus.org"

# This is the base64 compressed tar of entrypoint.sh
COPY <<EOF /entrypoint.64
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
8TAexsN4GA/j68Z/ADpKNaIAKAAA
EOF

RUN <<EOF
    cat /entrypoint.64 | base64 -d | tar zxf - > /entrypoint.sh
EOF

# These are the default ports in use by GCSv5.4. Currently, they can not be changed.
#   443 : HTTPD service for GCS Manager API and HTTPS access to collections
#  50000-51000 : Default port range for incoming data transfer tasks
EXPOSE 443/tcp 50000-51000/tcp

# Default command unless overriden with 'docker run --entrypoint'
ENTRYPOINT ["/entrypoint.sh"]
# Default options to ENTRYPOINT unless overriden with 'docker run arg1...'
CMD []
