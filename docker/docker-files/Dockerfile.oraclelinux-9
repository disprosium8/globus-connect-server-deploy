# syntax=docker/dockerfile:1.3-labs

############## STAGE 1 - Prepare the image for GCS installation ################
FROM oraclelinux:9

# Prereqs
RUN <<EOF
    dnf install -y coreutils gzip python3 sudo tar util-linux
EOF

##################### STAGE 2 - Install GCS using Ansible ######################
# This is the base64 compressed tar of the ansible repo directory
COPY <<EOF /ansible.64
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
IYcccsghhxxyeBL4Hx3p52MAeAAA
EOF

RUN <<EOF
    set -e
    /usr/bin/python3 -m venv /venv
    /venv/bin/pip install --upgrade pip
    /venv/bin/pip install ansible
    cat /ansible.64 | base64 -d | (cd /; tar zxf -)
EOF

#COPY <<EOF /ansible/playbook.yml
#- hosts: all
#  roles:
#    - globus-connect-server
#EOF

ARG GLOBUS_ANSIBLE_OPTIONS

RUN <<EOF
    (cd /ansible; /venv/bin/ansible-playbook playbook.yml ${GLOBUS_ANSIBLE_OPTIONS})
EOF

######################### STAGE 3 - Prepare GCS Image ##########################
LABEL maintainer="support@globus.org"

# This is the base64 compressed tar of entrypoint.sh
COPY <<EOF /entrypoint.64
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
EOF

RUN <<EOF
    cat /entrypoint.64 | base64 -d | tar zxf - > /entrypoint.sh
EOF

# These are the default ports in use by GCSv5.4. Currently, they can not be changed.
#   443 : HTTPD service for GCS Manager API and HTTPS access to collections
#  50000-51000 : Default port range for incoming data transfer tasks
EXPOSE 443/tcp 50000-51000/tcp

# Default command unless overriden with 'docker run --entrypoint'
ENTRYPOINT ["/entrypoint.sh"]
# Default options to ENTRYPOINT unless overriden with 'docker run arg1...'
CMD []
