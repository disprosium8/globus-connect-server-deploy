# syntax=docker/dockerfile:1.3-labs

############## STAGE 1 - Prepare the image for GCS installation ################
FROM fedora:38

# Prereqs
RUN <<EOF
    dnf install -y coreutils gzip python3 sudo tar util-linux
EOF

##################### STAGE 2 - Install GCS using Ansible ######################
# This is the base64 compressed tar of the ansible repo directory
COPY <<EOF /ansible.64
H4sIAAAAAAAAA+0ca3PbNjKf9StQ+WaUZI6kqGerWr5zE8fxnBt7LKdzHV9OgUhIQkUSLEHaUZv+
99sFSD0syZIcW76m3CQSBQIL7GKx2F0sQgPJex6znj0ilAGa9fqzcqNsN+u2+i6XbVWewjO7Vms0
KtV6uVp+VrbtCnyR+mMOKoNExjQi5FkkRHxXvXXv/6RA0/lPv02nP3jwPnCCG7Xaqvm3y5VaOv+2
XW5CPbtardSfkfKDj2QJ/MXn/8plfZp4sfxQ2CvskcN3nZMfTo+6r87evTk5bpHLIZeEBdc8EoHP
gphc04hTEBRywz2PxAw/hoyk4kMc4fs0cAHTzZBFjMSC9HngQh3A0+cgYOR12iG+c5IoQqwuj5gT
i2hswiig8RsR+TRuwdOkvzY8egkj36s+oBHWOxUOjbkIiOiToZAx8biMn8sXBR5cQxVA2DatyXOh
EAmPyW5I42FbPSKOwwQGQq8Fd6Ui5XwcD0VQJSyKRIRkBITHpE89T5IedUYEurMSGVk9HlihqoxF
0BSQlSLmi5iViBzLmPkm6TCGZAzjOJQty3KFI83JWhN+tu4sj8ZMxlbE+sC2wGFdGoYscLnDJBAQ
syiMGHx2XS4dcc2AU8PY9wqzr/RY2hToQbpei6AUkzDiwYCU5IgDPrdEYipHsgBYQo+Ou2lxF3kn
gcVApWSFp5bJHHYHmfxNFskj9LFG/5fL9Sbo/2rNrtj1RrWK+h92glz/7wKuPFChHq7/DwW70jTL
8MfO1HnXEUEAihk0bFvVy1XD1wbZ+sftoCfEyBz73kP3sXb9Nyq313+9Wc7X/y7AUHaTbBGwbwqE
KKuoBQ+EGGTgiV4ijVQJGJJFYHjkKuCrgmz9Xxwdvv7xyPTdR+hjzfqv1ir21P+voP9fqZcb+frf
Bez3ImIdFPZDUAB8ELSLDkOXongAOmB/WL1devyqQw5TX+883TL2rWEVMFjhQaGw77KYcvCUBHgv
7SJ+alQyAccwGh9cKmcO3LVXAjAGsdy3sldYTXgHSvnse1w/wCMlQ3CL2sU92hNJbICjZYSR+AVU
UvHgEIvAS4XR6KJ9i96BAeY6Bo0GHqrhcZ/HynmUxYOOKgezxyWn0/IpLitDthTrUNwYrjC4kUhm
oKdr9EVk8AB687ysi7QVIW/FDXEFOSFQO/WLwc+cq/2PrIvlA5j27IF/GEhWPDjVD9hgVV1Q4zFF
nr3SD3fUfTWkwYB5YgCVs8fZ6vsWztO+lU42zPse+NG3p6KgggfpVOH3NXcZuv3CQ0+bxkQmYSii
WLndLgs9MVYxBpCOq2O196CU4N4DbjTuPR+eZ370zc2NqbcnU0QDa36negGsRa83FVSTnEBXiABm
GP4SXPExVggF+M+K/eBq6x/U9XnAZRxRcIYkUf41OObMhUeCrrVP8cfMaLE5EOcmjo5ERAQ9eYU+
iUIhmTQnS2YUiBuPuQNGOI4FJB9wwVgdpnjAPlE/hA1YB1d8HdAYMW9MAgYVY0F6DEZIw1j/6vOY
jEUSzUZozELh5UtYptd1MgRqOfj14gYDJH3ucJCwsZFyHVBczUodEuEwNwFyp3xW8YqVjE5NAuO6
PiftxiCBmbZevHxp6gBS+pJFIPhAXSBiEgEDqSKbxrpnqdcfkAQtUrLV2yR0MTiCBMfz2ACJ0Lzy
6ID0GSziiEGpxyiwHeVIMcJU8rnRuivYJjmGITieCPScqD6ga8XnOX4FwmVq7Xz8+FEOmbKfCPkb
GUzaZ1yEkmHSU/EezcAVfNRSZUL1DG+hAtKrO50EpnSwiYAQD1icBZoKVYw1xUlIQpCrGxG5HnK0
03mr+XarPhZSEGjHEUkQaz6juMgEWASl0NYs1ExykQTkY2ojGJmPQAxjGl/b13i7Gu/B3+ElMDhq
7+tIWBd/HJBZ9+Kjno9UZRUOgTQY7win3RHhOOKDoVYJ7wMOXJE8HqsNY8gdOhCwmKCBqiRhchTn
XI0xVWyFczX/aVARDduJovk1waUJM430f0xL/zmVbxjaU2/IO4bM/lOG/yOdAm12/jPr/4EhWM3P
f3YB8/O/VC19sVRsOv8VuwZ+P9SzG41yLZ//XcAm858dEd1XEDY9/61XmtVmFcor5Vqlks//LmCr
+fcpD+4RIFwf/2uk67/ebNabMP+VcjP3/3cCe+gNgQB8ToL0IfVePocRM3RRYeDILtrBrbTyX81I
+ophk/Wvzoy/wArYTP/XYdu3G9UG7v/NZjW3/3YCm89/6vt2XdbjdKttYI3+r2HOT7r/N1T+V6Va
w/nP9f/jw97WUNhTscmTd53Lw9PTw8uTs3fkzdkFed9LgjixXivxKNwDr05ASiNlfXDkVQQni8C1
1OvJybSQ3T71uTdukazH6UsXA3i8l6Cr3/XpLyLqqkCCCFrELpPPxLbx41v4qODPSmVl6zSY1CKw
LmAgULmXeJ5kY4aPUIM78NDHw3H4/oX6/hi+RzxgMXdWYc3GDDU11zDrySAB9aGjLNyDERAMt+PG
KznGWggYYjzgKoBRIKTHHIENxgx/0TDW53awPlsz+UY3gSeouz6IZ/3+O1GbfJcHff6Jyats1/9A
/vjDmgTdpIVlYBP2Mjyqkc5f6kIVE16pgWCwHYYXYpAG07UyAo8CdQag6FsW5SUwkqxv6HrKAM4W
yU7jiJp0TOxqEYvFjgXssKRIIodJE5PCTHdFzG2+M/x5lxxAFYVOdRexAfsUtkjpv3v/kS+BbFJK
y/WYSCkrwyyyyalq1ts3bVLU9lRx2aup/VWc8u41l2uYp5vMSM3Ds0x3cU9WreDUHtmYV5sL0pSF
d/EDg47Z0gE9syUzpn1sxRBHH3+1yOf0rAfJv5J8EDDX6I3bKsNQDmnEZpeZdXH+o3F8fmz86+hn
Q9NsDsLBh8l67yXcm1/sW2gATQYubbKeFEUBlK+asfYqEd5m1sJIfNpiwuCfCcPq42TBOLLWS7h9
6Pya8Ii1Wsi4VkvVbLUWuAdCJ5yRrA+BtamiUFWB/uL3m1I+fa3bcqkVOXOnTHmvzjgUUw7PL4lD
nSFbreL1iUhX1dIvl+8ey9i7GqtGsFQ06rVlGv2pbZccvhy2t/8j5g5p/HD2v1227SrGf8ABrDXL
FVvb/3n+/07g3vb/ogNwwdy3NCavjy5OfoLSn4465i7dgLT7z6Sjct5d6rFNfYImtEJn4Dv495lU
6/jRwI/magv+0PPpKQ+ST1DvFWjDsw48vGGuiCg8nEXU8Vj2fjK0C9hNxreGiLn6J/4kD+Lo/OiU
jNiYgL3kcYfH3hgVNtWn1mzCmXHiE1+4CTzioTrm+mN6gsEVKsAJONSFhjG5oWOsbrlBX52WL90s
VL9gXsz6G4Bi0XoM/S6U6y0DH6a+hmf2Ff1pyoeyNMKkZ7GQeXOWC/a10lqamxvYaG9ts8vaKPNQ
8764fCtU1N1hAwJ7ZjfBzUjCDyO1iAztAG1MlRkIGjlDE9i5bGvdluY9cswCFmF+B6EeTLjMUGHe
ytFpk3CfDpgE7zUmHotLElNJZBIxc4FfwAvcAfp8YPg0gFaLNsMtdmELGJQn70fKLeag/dRUNB2p
JeBhAgCfTCZeSLpmmAMhksEwzRehRIp+jGk5LHBZ4IyzLInJxKPgZgsJUOu1MpvOAUpmHge4mzon
AVmRRMogxQwVCYwgavxCkiG9ZjgGVztm7iI7cdVtx05oYaQXqZ7Pt3zxIAz+ZsJgUCBd4MSwi4l6
3HWQXhGgDKHpDWh85OPR6bfAlYhfA6Mwieo5ChEm8Wi99mKpd7qAOlVWMCpG/UUrNM3VQhM85oGp
Emo0TY7vKp5M1F3aizFe6OR+wvZtcd0604QWb6nq49OzH953nkJZY1zoy3T1Mq8QM/NGPLYGcSPz
BZXTCWiWOJ5fHLFapXMfK2SFZMz40qnG3koRP0aAZllUa91qKCrKobAbjgZdfxChQ24Y2crQHRtp
x4bu2KgbnYlH+mABqbXefJYM+Rj0suBOci911yvpxbUfT+s8EMHZQepTUPw+kHdPMZKcBA8+ycsC
bcuoXhq5AT1gqlYrY2z1mSibqro8qHO1ii3n0FrL/oe0KtLVXk5LnUB1oquntXtg4CWR137IKBtq
I5xjl+PUWpvajdbfcDCosax0cH3KPbwR7DOwiNw2eBbA+3icvtUC47bt9Hf2uv3dt2nJIBw4Q+aM
JlWgAPaKNt7WBlrVFIUjjgM24NWynYDgNe302hASpMW3pE3nEuF98nzp1grSWNImbOkFYR5smiXm
lTC49gRRRY8HDPcRbzEyfl8JRZQt3V17ZSBR1YS9ikUx7YOTC7ScvXnI2GK2PW8WDry1K+fhwK8b
to//STBut0sCW3f+36iXJ///h431KlW7Ucvjf7uAB4z/nZ0fveu87xw9cgRwspeQydV1YviLBhVe
hnixOlzY0XGAzXIG6uvyA4otUltZJ8VTRETmymotdWdOMfCU0XAhMLi5t/nbOAxhx9vC4UxbfN3+
piYydznv6ZBMpYr3x2pEX7PDuYzar9ndvAe9f0pnE+m0/preJhpuK/3M/3sPczt3cDufZ3Fn2MLt
IbO3bzWOt5eX553u+cXZv39WrnBppfOnneNl/lvmEGt3+NGcq83t/3te/ni2/v5HtTFj/9uY/2tX
G/n9j53AwoIBeyqkzggPC+fjOvA+cGnk8t9YZkSny5mkB0EtonNDJsXTY+6FVzoBtkV0Nvm0RYK5
tqipChgUcbzEZV0lf7ozpTJIMfNF0RpbHNfVgrmPxhnKbjEPUtyCTdY/CsGXXALd6v5fDe//NutN
O7//sQvYeP7vr/7X6/+Kyv+qVRt1FALU/5X8/sduYM6ZRR2rTanJTT8ycTBakycoTP2YVvZQIDNm
+aRxYe4EKz0VWEwvWX1CsHhYX2pOjgoWEyu0rfTULM0hhxxyyCGHHHLIIYcccsghhxxyyCGHHHLI
IYcccsghhxxyeBL4Hx3p52MAeAAA
EOF

RUN <<EOF
    set -e
    /usr/bin/python3 -m venv /venv
    /venv/bin/pip install --upgrade pip
    /venv/bin/pip install ansible
    cat /ansible.64 | base64 -d | (cd /; tar zxf -)
EOF

ARG GLOBUS_ANSIBLE_OPTIONS

# Modifying this arg value on the build command line will cause RUN to reinstall
# Globus instead of using the previous, cached iteration (if it exists). Useful
# for speeding up re-runs to get newer Globus versions.
ARG CACHEBUST=1

RUN <<EOF
    (cd /ansible; /venv/bin/ansible-playbook playbook.yml ${GLOBUS_ANSIBLE_OPTIONS})
EOF

######################### STAGE 3 - Prepare GCS Image ##########################
LABEL maintainer="support@globus.org"

# This is the base64 compressed tar of entrypoint.sh
COPY <<EOF /entrypoint.64
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
Kx/H43gcj+NxPI7H8Tgex+eN/wGog4rkACgAAA==
EOF

RUN <<EOF
    cat /entrypoint.64 | base64 -d | tar zxf - > /entrypoint.sh
EOF

# These are the default ports in use by GCSv5.4. Currently, they can not be changed.
#   443 : HTTPD service for GCS Manager API and HTTPS access to collections
#  50000-51000 : Default port range for incoming data transfer tasks
EXPOSE 443/tcp 50000-51000/tcp

# Default command unless overriden with 'docker run --entrypoint'
ENTRYPOINT ["/entrypoint.sh"]
# Default options to ENTRYPOINT unless overriden with 'docker run arg1...'
CMD []
